<!doctype html>

<html lang="en">

<head>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="/percent-calculator/icons/android-launchericon-192-192.png">
<meta name="theme-color" content="#0b0f14">


<meta charset="utf-8"/>

<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>% Range Calculator</title>

<style>

:root{

  --bg:#0b0f14;

  --panel:#121826;

  --panel-2:#0f1522;

  --border:rgba(255,255,255,.08);

  --border-2:rgba(255,255,255,.06);

  --text:rgba(255,255,255,.92);

  --muted:rgba(255,255,255,.60);

  --muted2:rgba(255,255,255,.45);

  --blue:#2d7dff;

  --green:#78c499;

  --red:#c27467;

  --rowA:rgba(255,255,255,.015);

  --rowB:rgba(255,255,255,.035);

  --rowHover:rgba(255,255,255,.06);

  --rowActive:rgba(45,125,255,.14);

  --rowActiveBorder:rgba(45,125,255,.35);

}

*{box-sizing:border-box;}

body{

  margin:0;

  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;

  background:var(--bg);

  color:var(--text);

}

.wrap{max-width:760px;margin:18px auto;padding:0 14px 22px;}

.topbar{

  display:flex;

  justify-content:space-between;

  align-items:center;

  padding:10px 2px 14px;

  color:var(--muted);

  letter-spacing:.08em;

  text-transform:uppercase;

  font-weight:700;

  font-size:12px;

}

.status{

  color:rgba(255,255,255,.45);

  font-weight:650;

  letter-spacing:.04em;

  text-transform:none;

}

.card{

  background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);

  border:1px solid var(--border);

  border-radius:14px;

  overflow:hidden;

}

.section{padding:14px;border-bottom:1px solid var(--border-2);}

.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}

.grid2{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}

.field label{

  font-size:11px;color:var(--muted2);letter-spacing:.06em;text-transform:uppercase;

  display:block;margin:2px 2px 6px;

}

.input{

  width:100%;

  padding:12px;

  border-radius:12px;

  border:1px solid var(--border);

  background:rgba(255,255,255,.03);

  color:var(--text);

  font-size:16px;

  outline:none;

}

.input:focus{

  border-color:rgba(45,125,255,.55);

  box-shadow:0 0 0 3px rgba(45,125,255,.14);

}

.btnRow{

  display:flex;gap:10px;flex-wrap:wrap;

  padding:14px;border-bottom:1px solid var(--border-2);

}

button{

  border:1px solid var(--border);

  background:rgba(255,255,255,.04);

  color:var(--text);

  padding:10px 12px;

  border-radius:12px;

  font-size:14px;

  font-weight:650;

  cursor:pointer;

  user-select:none;

}

button:active{transform:translateY(1px);}

button:disabled{opacity:.55;cursor:default;}

.primary{

  background:rgba(45,125,255,.16);

  border-color:rgba(45,125,255,.35);

}

.chip{

  padding:10px 12px;

  border-radius:999px;

  background:rgba(255,255,255,.04);

}

.chip.primary{

  background:rgba(45,125,255,.14);

  border-color:rgba(45,125,255,.28);

}

.error{

  display:none;

  padding:12px 14px;

  color:var(--red);

  border-bottom:1px solid var(--border-2);

  font-size:13px;

}

/* Webull-style change badge */
.chgWrap{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:44px; /* keeps grid row height stable */
}

.chgBadge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
  font-variant-numeric: tabular-nums;
  line-height:1;
}

.chgBadge.is-hidden{ display:none; }

.chgTf{
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--muted2);
  padding:3px 8px;
  border-radius:999px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06);
}

.chgArrow{
  font-size:12px;
  opacity:.95;
}

.chgVal{
  font-size:14px;
  font-weight:750;
  letter-spacing:.01em;
}

/* Positive / negative styling */
.chgBadge.is-pos{
  border-color: rgba(120,196,153,.35);
  background: rgba(120,196,153,.10);
}
.chgBadge.is-pos .chgArrow,
.chgBadge.is-pos .chgVal{ color: var(--green); }

.chgBadge.is-neg{
  border-color: rgba(194,116,103,.35);
  background: rgba(194,116,103,.10);
}
.chgBadge.is-neg .chgArrow,
.chgBadge.is-neg .chgVal{ color: var(--red); }

/* TABLE */

table {
  width: auto;
  margin: 0 auto;          /* center table */
  border-collapse: collapse;
  font-variant-numeric:tabular-nums;
}

thead th{

  position:sticky;top:0;z-index:2;

  background:rgba(18,24,38,.96);

  border-bottom:1px solid var(--border-2);

  color:var(--muted);

  font-size:11px;

  letter-spacing:.08em;

  text-transform:uppercase;

  padding:13px 25px;

  text-align:center;

}

/* widths tuned */

th.colP, td.colP{ width:34%; text-align:center; }

th.colMinus, td.colMinus{ width:33%; text-align:center; }

th.colPlus, td.colPlus{ width:33%; text-align:center; }

tbody tr{cursor:pointer;transition:background .12s ease,opacity .12s ease;}

tbody tr:nth-child(odd){background:var(--rowA);}

tbody tr:nth-child(even){background:var(--rowB);}

tbody tr:hover{background:var(--rowHover);}

tbody tr.is-active{

  background:var(--rowActive)!important;

  box-shadow:inset 3px 0 0 0 var(--rowActiveBorder);

}

tbody.has-active tr:not(.is-active){opacity:.55;}

tbody td{

  padding:13px 25px;

  border-bottom:1px solid var(--border-2);

  font-size:16px;

  white-space:nowrap;

}

.pct{font-weight:650;}

.neg{color:var(--red);font-weight:650;}

.pos{color:var(--green);font-weight:650;}

.hint{padding:12px 14px;font-size:12px;color:var(--muted2);}

@media (max-width:520px){

  .grid{grid-template-columns:1fr 1fr;}

  .grid .field:nth-child(3){grid-column:1 / -1;}

  tbody td{padding:12px 12px;font-size:15px;}

  thead th{padding:11px 12px;}

  th.colP, td.colP{width:34%;}

  th.colMinus, td.colMinus{width:33%;}

  th.colPlus, td.colPlus{width:33%;}

}

</style>

</head>

<body>

<div class="wrap">

  <div class="topbar">

    <div>% Range Calculator</div>

    <div class="status" id="status">0DTE-ready</div>

  </div>

  <div class="card">

    <div class="section">

      <div class="grid">

        <div class="field">

          <label>Price</label>

          <input id="base" class="input" inputmode="decimal" value="1000"/>

        </div>

        <div id="chgWrap" class="chgWrap" aria-live="polite">
          <div id="chgBadge" class="chgBadge is-hidden">
            <span id="chgTf" class="chgTf">1W</span>
            <span id="chgArrow" class="chgArrow">▲</span>
            <span id="chgVal" class="chgVal">+0.00%</span>
          </div>
        </div>

        <div class="field">

          <label>Step (%)</label>

          <input id="step" class="input" inputmode="decimal" value="0.5"/>

        </div>

        <div class="field">

          <label>Max (%)</label>

          <input id="max" class="input" inputmode="decimal" value="5"/>

        </div>

      </div>

      <div class="grid2">

        <div class="field">

          <label>Decimals</label>

          <input id="decimals" class="input" inputmode="numeric" value="2"/>

        </div>

      </div>

    </div>

    <div class="btnRow">

      <!-- ETF quick fill -->

      <button class="chip primary" id="btnSPY" type="button">SPY</button>

      <button class="chip" id="btnQQQ" type="button">QQQ</button>

      <button class="chip" id="btnIWM" type="button">IWM</button>

      <!-- controls -->

      <button class="primary" id="calc" type="button">Calculate</button>

      <button id="btnW1" class="">W-1: OFF</button>

      <button id="auto" type="button">Auto: ON</button>

      <button id="focus" type="button">Focus: ON</button>

      <button id="clear" type="button">Clear</button>

    </div>

    <div id="err" class="error"></div>

    <table id="tbl">

      <thead>

        <tr>

          <th class="colP">%</th>

          <th class="colMinus">-</th>

          <th class="colPlus">+</th>

        </tr>

      </thead>

      <tbody id="tbody"></tbody>

    </table>

    <div class="hint">Tap a row to lock highlight. Use SPY/QQQ/IWM buttons to auto-fill base.</div>

  </div>

</div>

<script>

document.addEventListener("DOMContentLoaded", () => {

  const $ = (id) => document.getElementById(id);
  const baseEl = $("base");
  const stepEl = $("step");
  const maxEl  = $("max");
  const decEl  = $("decimals");
  const errEl = $("err");
  const bodyEl = $("tbody");
  const statusEl = $("status");
  const btnSPY = $("btnSPY");
  const btnQQQ = $("btnQQQ");
  const btnIWM = $("btnIWM");
  const calcBtn = $("calc");
  const autoBtn = $("auto");
  const focusBtn = $("focus");
  const clearBtn = $("clear");
  const chgEl = $("chg");
  const chgBadge = $("chgBadge");
  const chgTf = $("chgTf");
  const chgArrow = $("chgArrow");
  const chgVal = $("chgVal");
  const btnW1 = document.getElementById("btnW1");

  let swapped = false;        // kept for future if you re-add swap
  let autoCalc = true;
  let focusMode = true;
  let activeSymbol = null;
  let usePriorWeekClose = false;


  function parseNum(v){
    if (typeof v !== "string") return NaN;
    v = v.trim().replace(",", ".");
    return v === "" ? NaN : Number(v);
  }

  function clampDecimals(v){
    const n = Math.floor(parseNum(v));
    if (!Number.isFinite(n)) return 2;
    return Math.max(0, Math.min(10, n));
  }

  function fmt(n, decimals){
    return Number.isFinite(n) ? n.toFixed(decimals) : "";
  }

  function showError(msg){
    errEl.textContent = msg;
    errEl.style.display = "block";
  }

  function clearError(){
    errEl.textContent = "";
    errEl.style.display = "none";
  }

  function clearSelection(){
    bodyEl.classList.remove("has-active");
    bodyEl.querySelectorAll("tr.is-active").forEach(tr => tr.classList.remove("is-active"));
  }

  function applyFocusClass(){
    const hasActive = !!bodyEl.querySelector("tr.is-active");
    bodyEl.classList.toggle("has-active", focusMode && hasActive);
  }

  function buildTable(){
    const base = parseNum(baseEl.value);
    const step = parseNum(stepEl.value);
    const max  = parseNum(maxEl.value);
    const decimals = clampDecimals(decEl.value);

    if (!Number.isFinite(base)) return showError("Enter a valid base value (e.g., 685).");
    if (!Number.isFinite(step) || step <= 0) return showError("Step must be a positive number (e.g., 0.5).");
    if (!Number.isFinite(max)  || max  <= 0) return showError("Max (%) must be a positive number (e.g., 5).");
    if (step > max) return showError("Step (%) cannot be greater than Max (%).");
    clearError();
    const count = Math.floor((max + 1e-12) / step);
    bodyEl.innerHTML = "";
    for (let i = 1; i <= count; i++){
      const p = i * step;
      const plusVal  = base * (1 + p/100);
      const minusVal = base * (1 - p/100);
      const tr = document.createElement("tr");
      const pStr = (Math.round(p * 100) / 100).toString().replace(/\.0+$/,"").replace(/(\.\d)0$/,"$1");
      tr.innerHTML = `
        <td class="colP pct">${pStr}%</td>
        <td class="colMinus neg">${fmt(minusVal, decimals)}</td>
        <td class="colPlus pos">${fmt(plusVal, decimals)}</td>
      `;

      tr.addEventListener("click", () => {
        const isActive = tr.classList.contains("is-active");
        clearSelection();
        if (!isActive) tr.classList.add("is-active");
        applyFocusClass();
      });
      bodyEl.appendChild(tr);
    }
    applyFocusClass();
  }

  function maybeAuto(){ if (autoCalc) buildTable(); }

  // ===== ETF price fetch  =====

  const API_KEY = "03263123023e425fbe5ec22a54a12363";
  const etfButtons = [btnSPY, btnQQQ, btnIWM];

  async function fetchQuote(symbol){
    const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(symbol)}&apikey=${API_KEY}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Quote fetch failed");
    const data = await res.json();
    if (data.status === "error") throw new Error(data.message || "API error");
    const last = Number(data.close ?? data.price);
    const prevClose = Number(data.previous_close);
    const dayPct = Number(data.percent_change);

    if (!Number.isFinite(last)) throw new Error("No last price");
    return { last, prevClose, dayPct, raw: data };
  }

  async function fetchPriorWeekClose(symbol){
    const url = `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(symbol)}&interval=1week&outputsize=5&apikey=${API_KEY}`;
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();

    if (data.status === "error") throw new Error(data.message || "API error");

    const values = data.values;
    if (!Array.isArray(values) || values.length < 2) throw new Error("Not enough weekly data");

    // values[0] can be current in-progress week. We want the prior completed week close:
    const close = Number(values[1].close);
    if (!Number.isFinite(close)) throw new Error("Bad close");

    return close;
  }
    
  function setChangeBadge({ tf, pct }) {
    if (!Number.isFinite(pct)) {
      chgBadge.classList.add("is-hidden");
      chgBadge.classList.remove("is-pos","is-neg");
      return;
    }

    const sign = pct >= 0 ? "+" : "";
    chgTf.textContent = tf;                 // "1D" or "1W"
    chgVal.textContent = `${sign}${pct.toFixed(2)}%`;

    chgBadge.classList.remove("is-pos","is-neg","is-hidden");
    if (pct >= 0) {
      chgBadge.classList.add("is-pos");
      chgArrow.textContent = "▲";
    } else {
      chgBadge.classList.add("is-neg");
      chgArrow.textContent = "▼";
    }
  }

  function setActiveEtfButton(activeBtn){
    etfButtons.forEach(b => b.classList.remove("primary"));
    activeBtn.classList.add("primary");
  }

  async function setBaseFromSymbol(symbol, btn){
    console.log(activeSymbol);
    const old = btn.textContent;
    btn.disabled = true;
    btn.textContent = symbol + "…";
    activeSymbol = symbol; 
    setActiveEtfButton(btn);
    try{
      const q = await fetchQuote(symbol);
      let px;
      if (usePriorWeekClose){
        const w1 = await getPriorWeekCloseCached(symbol);   // usually cached
        px = w1; // base becomes last week's close
        const pct = ((q.last / w1) - 1) * 100;
        const sign = pct >= 0 ? "+" : "";
        setChangeBadge({ tf: "1W", pct });
      }else{
        px = q.last; // base becomes last/current price

        // Prefer API-provided day %; fallback to compute
        const dayPct = Number.isFinite(q.dayPct)
          ? q.dayPct
          : (Number.isFinite(q.prevClose) ? ((q.last / q.prevClose) - 1) * 100 : NaN);
        if (Number.isFinite(dayPct)){
          const sign = dayPct >= 0 ? "+" : "";
          setChangeBadge({ tf: "1D", pct: dayPct });
        }else{
          setChangeBadge({ tf: "—", pct: NaN });
        }
      }

      if (!Number.isFinite(px)) throw new Error("No price returned");
      baseEl.value = px.toFixed(2);
      maybeAuto()
      statusEl.textContent = usePriorWeekClose ? `${symbol} Last week` : `${symbol} live price`;
      setTimeout(() => { statusEl.textContent = "Ready"; }, 1200);

    }catch(e){
      showError(`Could not fetch ${symbol} price (some previews block external fetch).`);
      statusEl.textContent = "Ready";

    }finally{
      btn.disabled = false;
      btn.textContent = old;
    }
  }

  function isoWeekKey(d = new Date()){
    // ISO week key "YYYY-Www" (good enough for cache invalidation)
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
  }

  async function getPriorWeekCloseCached(symbol){
    const key = `w1close_${symbol}`;
    const wk = isoWeekKey(new Date());
    const cached = localStorage.getItem(key);
    if (cached){
      try{
        const obj = JSON.parse(cached);
        if (obj && obj.weekKey === wk && Number.isFinite(obj.close)) return obj.close;
      }catch{}
    }

    // cache miss → 1 API call (once per week per symbol)
    const close = await fetchPriorWeekClose(symbol);
    localStorage.setItem(key, JSON.stringify({ weekKey: wk, close }));
    return close;
  }

  btnSPY.addEventListener("click", () => setBaseFromSymbol("SPY", btnSPY));
  btnQQQ.addEventListener("click", () => setBaseFromSymbol("QQQ", btnQQQ));
  btnIWM.addEventListener("click", () => setBaseFromSymbol("IWM", btnIWM));

  baseEl.addEventListener("input", () => {
    etfButtons.forEach(b => b.classList.remove("primary"));
    setChangeBadge({ tf: "—", pct: NaN });
    activeSymbol = null;
  });

    // Controls

  function updateW1UI(){
    btnW1.textContent = usePriorWeekClose ? "1w: ON" : "1w: OFF";
    btnW1.classList.toggle("primary", usePriorWeekClose); 
  }

  btnW1.addEventListener("click", () => {
    usePriorWeekClose = !usePriorWeekClose;
    updateW1UI();
  });

  updateW1UI();

  calcBtn.addEventListener("click", buildTable);
  autoBtn.addEventListener("click", () => {
    autoCalc = !autoCalc;
    autoBtn.textContent = `Auto: ${autoCalc ? "ON" : "OFF"}`;
    if (autoCalc) buildTable();
  });

  focusBtn.addEventListener("click", () => {
    focusMode = !focusMode;
    focusBtn.textContent = `Focus: ${focusMode ? "ON" : "OFF"}`;
    applyFocusClass();
  });

  clearBtn.addEventListener("click", clearSelection);

  [baseEl, stepEl, maxEl, decEl].forEach(el => {
    el.addEventListener("input", maybeAuto);
    el.addEventListener("keydown", (e) => { if (e.key === "Enter") buildTable(); });
  });

  buildTable();

});

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}

</script>

</body>

</html>
